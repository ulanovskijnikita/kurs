<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/output.css">
    <script>
        let key = localStorage.key(0)
        document.title = decodeURIComponent( key )
    </script>
</head>

<body>
    <header class="grid items-center grid-cols-3 justify-between ">
        <div class="col-span-1 link font-bold justify-start desktop:justify-start">
            <a href="../../../index.html" class="flex items-center gap-5 active:text-accent">
                <svg class="fill-current w-25 h-25 tablet:w-30 tablet:h-30 desktop:w-33 desktop:h-33" width="50"
                    height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12.5 0H18.75C20.4785 0 21.875 1.39648 21.875 3.125V12.5H9.375V3.125C9.375 1.39648 10.7715 0 12.5 0ZM0 25C0 19.8242 4.19922 15.625 9.375 15.625H21.875C27.0508 15.625 31.25 19.8242 31.25 25V45.3125C31.25 47.9004 29.1504 50 26.5625 50H4.6875C2.09961 50 0 47.9004 0 45.3125V25ZM23.4375 32.8125C23.4375 30.7405 22.6144 28.7534 21.1493 27.2882C19.6841 25.8231 17.697 25 15.625 25C13.553 25 11.5659 25.8231 10.1007 27.2882C8.6356 28.7534 7.8125 30.7405 7.8125 32.8125C7.8125 34.8845 8.6356 36.8716 10.1007 38.3368C11.5659 39.8019 13.553 40.625 15.625 40.625C17.697 40.625 19.6841 39.8019 21.1493 38.3368C22.6144 36.8716 23.4375 34.8845 23.4375 32.8125ZM25 6.25C25 5.4212 25.3292 4.62634 25.9153 4.04029C26.5013 3.45424 27.2962 3.125 28.125 3.125C28.9538 3.125 29.7487 3.45424 30.3347 4.04029C30.9208 4.62634 31.25 5.4212 31.25 6.25C31.25 7.0788 30.9208 7.87366 30.3347 8.45971C29.7487 9.04576 28.9538 9.375 28.125 9.375C27.2962 9.375 26.5013 9.04576 25.9153 8.45971C25.3292 7.87366 25 7.0788 25 6.25ZM37.5 3.125C38.3288 3.125 39.1237 3.45424 39.7097 4.04029C40.2958 4.62634 40.625 5.4212 40.625 6.25C40.625 7.0788 40.2958 7.87366 39.7097 8.45971C39.1237 9.04576 38.3288 9.375 37.5 9.375C36.6712 9.375 35.8763 9.04576 35.2903 8.45971C34.7042 7.87366 34.375 7.0788 34.375 6.25C34.375 5.4212 34.7042 4.62634 35.2903 4.04029C35.8763 3.45424 36.6712 3.125 37.5 3.125ZM43.75 6.25C43.75 5.4212 44.0792 4.62634 44.6653 4.04029C45.2513 3.45424 46.0462 3.125 46.875 3.125C47.7038 3.125 48.4987 3.45424 49.0847 4.04029C49.6708 4.62634 50 5.4212 50 6.25C50 7.0788 49.6708 7.87366 49.0847 8.45971C48.4987 9.04576 47.7038 9.375 46.875 9.375C46.0462 9.375 45.2513 9.04576 44.6653 8.45971C44.0792 7.87366 43.75 7.0788 43.75 6.25ZM46.875 12.5C47.7038 12.5 48.4987 12.8292 49.0847 13.4153C49.6708 14.0013 50 14.7962 50 15.625C50 16.4538 49.6708 17.2487 49.0847 17.8347C48.4987 18.4208 47.7038 18.75 46.875 18.75C46.0462 18.75 45.2513 18.4208 44.6653 17.8347C44.0792 17.2487 43.75 16.4538 43.75 15.625C43.75 14.7962 44.0792 14.0013 44.6653 13.4153C45.2513 12.8292 46.0462 12.5 46.875 12.5ZM43.75 25C43.75 24.1712 44.0792 23.3763 44.6653 22.7903C45.2513 22.2042 46.0462 21.875 46.875 21.875C47.7038 21.875 48.4987 22.2042 49.0847 22.7903C49.6708 23.3763 50 24.1712 50 25C50 25.8288 49.6708 26.6237 49.0847 27.2097C48.4987 27.7958 47.7038 28.125 46.875 28.125C46.0462 28.125 45.2513 27.7958 44.6653 27.2097C44.0792 26.6237 43.75 25.8288 43.75 25ZM37.5 12.5C38.3288 12.5 39.1237 12.8292 39.7097 13.4153C40.2958 14.0013 40.625 14.7962 40.625 15.625C40.625 16.4538 40.2958 17.2487 39.7097 17.8347C39.1237 18.4208 38.3288 18.75 37.5 18.75C36.6712 18.75 35.8763 18.4208 35.2903 17.8347C34.7042 17.2487 34.375 16.4538 34.375 15.625C34.375 14.7962 34.7042 14.0013 35.2903 13.4153C35.8763 12.8292 36.6712 12.5 37.5 12.5Z"
                        fill="" />
                </svg>
                <p class="hidden tablet:block tablet:py-10">МойНеСам</p>
            </a>
        </div>

        <div class="col-span-1 flex justify-center">
            <button type="button" class="btn cursor-pointer w-[280px] text-center" onclick="location.assign('./forum.html')">Назад</button>
        </div>

        <div class="col-span-1 link justify-end">
            <span class="sign-in hidden tablet:block tablet:active:text-main duration-300"></span>
            <svg tabindex="0" id="menu"
                class="hover:text-accent min-w-25 h-25 tablet:w-30 tablet:h-30 duration-300 cursor-pointer" width="34"
                height="34" viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M23.3987 14.2245C21.6128 15.7871 19.1906 16.665 16.665 16.665C14.1394 16.665 11.7172 15.7871 9.93132 14.2245C8.14544 12.6618 7.14214 10.5424 7.14214 8.3325C7.14214 6.12258 8.14544 4.00318 9.93132 2.44053C11.7172 0.877886 14.1394 0 16.665 0C19.1906 0 21.6128 0.877886 23.3987 2.44053C25.1846 4.00318 26.1879 6.12258 26.1879 8.3325C26.1879 10.5424 25.1846 12.6618 23.3987 14.2245ZM0 31.3966C0 24.9845 5.93691 19.7897 13.265 19.7897H20.065C23.0559 19.7897 25.815 20.655 28.0334 22.1153C27.7162 22.283 27.5 22.6162 27.5 23V30.0858L24.7071 27.2929C24.3166 26.9024 23.6834 26.9024 23.2929 27.2929C22.9024 27.6834 22.9024 28.3166 23.2929 28.7071L27.7876 33.2018C27.8072 33.2217 27.8276 33.2408 27.8488 33.259C27.8787 33.2847 27.9098 33.3084 27.9419 33.33H2.2096C0.989485 33.33 0 32.4642 0 31.3966ZM29.0581 33.33H31.1204C32.3405 33.33 33.33 32.4642 33.33 31.3966C33.33 30.5443 33.2251 29.7134 33.026 28.9135L29.2532 33.1578C29.2434 33.1691 29.2332 33.1802 29.2228 33.1911C29.2042 33.2105 29.1851 33.229 29.1653 33.2466C29.1311 33.2772 29.0952 33.305 29.0581 33.33ZM32.3511 27.0111C31.6883 25.5903 30.7131 24.3103 29.5 23.2365V29.8698L31.7526 27.3356C31.9144 27.1536 32.1277 27.0446 32.3511 27.0111Z"
                    fill="" />
            </svg>
        </div>

        <div class="hidden text-a absolute flex flex-col gap-15 items-end text-end bg-bg p-10 z-50 w-[72vw] tablet:w-[50vw] pr-container right-0"
            id="menuProfile">
            <a href="../../img/Руководство пользователя.png"
                class="active:text-accent desktop:hover:text-accent desktop:active:text-main duration-300">Руководство
                пользователя</a>
            <button id="exit"
                class="block w-fit active:text-accent desktop:hover:text-accent desktop:active:text-main duration-300">Выход
                из аккаунта</button>
        </div>
    </header>

    <main class="grid grid-cols-3 gap-50 tablet:gap-75 desktop:gap-200">
        <section class="col-span-3 py-100" id="current-theme">
            
        </section>
    </main>
    

    <script type="module">
        import getData from '../../js/getData.js';
        import autoWidth from '../../js/autoWidth.js';

        

        const menu = document.body.querySelector("#menu");
        const header = document.body.querySelector("header");

        const themes = await getData(`SELECT * FROM theme WHERE themeId = '${localStorage.getItem(key)}'`, '../query.php');

        document.body.querySelector('#current-theme')
        .insertAdjacentHTML('beforeend', 
            `
                <h2 class="pb-50 col-span-2">${themes[0].themeTitle}</h2>
                <p class="pb-50">${themes[0].themeText}</p>
                <h3>Комментарии</h3>
                <span class="w-100">оставить комментарий:</span>
                <form name="commetForm" method="post" class="pt-[50px] relative after:absolute after:bg-main after:-bottom-[40px] after:left-0 after:right-0 after:text-main after:h-1">

                    <label
                class="desktop:flex-row desktop:items-center flex flex-col col-span-1 rounded-5 outline outline-1 outline-main py-20 px-15 gap-20 text-accent focus-within:outline-2"><textarea type="password" required
                    class="bg-bg focus:outline-none w-full text-main"
                    name="text" placeholder="Ваш комментарий"></textarea>
                </label>
                <input class="hidden" name="themeId" type="text" value="${localStorage.getItem(key)}">
                    <button type="submit" class="btn mt-[50px] w-fit mx-auto col-span-2" id="comment-btn">Отправить</button>
                </form>
                
            `
        )

        document.forms.commetForm.onsubmit = async function(event) {
            event.preventDefault();
            
            
            let response = await fetch("../comment.php", {
                method: "POST",
                body: new FormData(this),
            });
            location.reload();
        }

        document.forms.commetForm.text.oninput = autoWidth

        const comments = await getData(`SELECT users.login, comment.commentText, comment.commentId FROM comment JOIN users ON comment.id = users.id WHERE comment.themeId = ${localStorage.getItem(key)} ORDER BY comment.commentId DESC`, '../query.php')
        
        comments.forEach(item => {
            document.body.querySelector('#current-theme')
        .insertAdjacentHTML('beforeend', 
            `<div class="col-span-ful">
                <h3 class="pb-25">${item.login}</h3>
                <p class="pt-25">${item.commentText}</p>
                ${(document.cookie.includes('employee')) ? `<button type="submit" class="btn mt-[50px] w-fit mx-auto col-span-2 delete-btn" data-delete="${item.commentId}">Удалить</button>` : ''}
            </div>
            `
        )
        })

        document.body.querySelectorAll('.delete-btn').forEach(item => {
            item.onclick = async function() {
                const objBody = {
                    query: `DELETE FROM comment WHERE commentId = '${this.getAttribute('data-delete')}'`
                };

                await fetch('../query.php', {
                    method: 'POST',
                    body: JSON.stringify(objBody)
                });
                location.reload();
            }
        })


        menu.addEventListener("click", function () {
            this.classList.toggle("text-accent");
            menuProfile.classList.toggle('hidden');
            menuProfile.style.top = `${header.offsetHeight}px`;
        });

        const signIn = document.body.querySelectorAll('.sign-in');
        const history = document.body.querySelector('#history');

        const colDate = document.querySelector('#colDate');
        const colTime = document.querySelector('#colTime');
        const colWork = document.querySelector('#colWork');
        const colStatus = document.querySelector('#colStatus');
        const colPrice = document.querySelector('#colPrice');

        const cookieArr = document.cookie.split('; ');

        const userNameCookie = cookieArr.find((value) => {
            return value.includes('userName=');
        });
        const userName = userNameCookie.substring(9);
        signIn.forEach(item => {
            item.insertAdjacentText('beforeend', userName);
        });

        const userIdCookie = cookieArr.find((value) => {
            return value.includes('userId=');
        });
        const userId = userIdCookie.substring(7);

        exit.addEventListener('click', function () {
            document.cookie = 'userId=; path=/; max-age=0;';
            document.cookie = 'userName=; path=/; max-age=0;';
            document.cookie = 'employee=; path=/; max-age=0;';
            location.assign('../../../index.html');
        });
    </script>
</body>

</html>